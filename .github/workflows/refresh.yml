name: Refresh Bundles & Patches
# Run Production on schedule OR manual trigger from main
# Run Development only on manual trigger from dev

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

permissions:
  contents: read
  deployments: write

jobs:
  refresh:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - environment: Production
            branch: refs/heads/main
          - environment: Development
            branch: refs/heads/dev

    environment: ${{ matrix.environment }}
    steps:
      - name: Call refresh endpoint (${{ matrix.environment }})
        if: |
          (github.event_name == 'schedule' && matrix.environment == 'Production') ||
          (github.event_name == 'workflow_dispatch' && github.ref == matrix.branch)
        env:
          SECRET: ${{ secrets.BACKEND_AUTHENTICATION_SECRET }}
          DEPLOY_ENDPOINT: ${{ vars.DEPLOY_ENDPOINT }}
        run: |
          TIMESTAMP=$(date +%s)
          PAYLOAD="refresh:$TIMESTAMP"
          HMAC=$(echo -n "$PAYLOAD" | openssl dgst -sha256 -hmac "$SECRET" | sed 's/^.* //')
          echo "Calling refresh on $DEPLOY_ENDPOINT (${{ matrix.environment }})"
          curl -X POST "$DEPLOY_ENDPOINT/api/v1/refresh/all" \
            -H "Authorization: Bearer $TIMESTAMP-$HMAC" \
            -H 'accept: application/json' \
            -d '' \
            -w "\nHTTP Status: %{http_code}\n"
          
          echo "current_env=${{ matrix.environment }}" >> $GITHUB_OUTPUT

  # This is ass I know, waiting for https://github.com/orgs/community/discussions/36919
  cleanup_deployment:
    name: 'Cleanup deployments'
    runs-on: ubuntu-latest
    needs: refresh
    if: always()
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Cleanup deployments
        run: |
          # Function to cleanup a deployment for a given environment
          cleanup_environment() {
            local environment=$1

            echo "Looking for $environment deployment..."

            DEPLOYMENT_ID=$(gh api repos/${{ github.repository }}/deployments \
              --method GET \
              --field sha=${{ github.sha }} \
              --field ref=${{ github.ref_name }} \
              --field task=deploy \
              --field environment="$environment" \
              --jq '.[0].id // empty')

            if [ -z "$DEPLOYMENT_ID" ]; then
              echo "No $environment deployment found"
              return 0
            fi

            echo "Found $environment deployment ID: $DEPLOYMENT_ID"

            # Deactivate deployment
            echo "Deactivating $environment deployment..."
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses \
              --method POST \
              --field state=inactive \
              --silent || echo "Failed to deactivate $environment deployment"

            # Delete deployment
            echo "Deleting $environment deployment..."
            gh api repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID \
              --method DELETE \
              --silent || echo "Failed to delete $environment deployment"

            echo "$environment deployment cleanup complete"
          }

          # Cleanup both environments
          cleanup_environment "Production"
          cleanup_environment "Development"
